name: Sign Commits

on:
  # push:
  #   branches: [master, main]
  workflow_dispatch:

permissions:
  id-token: write # Required for OIDC token
  contents: write # Required to push signed commits

jobs:
  sign:
    name: Sign Commits
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with: { fetch-depth: 0 }
      - uses: go-task/setup-task@v1

      - name: Get OIDC Token
        id: oidc
        uses: actions/github-script@v8
        with:
          script: |
            const token = await core.getIDToken('gpg-signing-service');
            core.setSecret(token);
            core.setOutput('token', token);

      - name: Sign Commit
        id: sign
        env:
          SIGNING_SERVICE_URL: ${{ vars.SIGNING_SERVICE_URL }}
          OIDC_TOKEN: ${{ steps.oidc.outputs.token }}
          REQUEST_ID: ${{ github.run_id }}-${{ github.run_number }}
        run: |
          # Get commit data
          COMMIT_DATA="$(git cat-file commit HEAD)"

          # Request signature from signing service (-f fails fast on HTTP errors)
          SIGNATURE="$(curl -sf -X POST "${SIGNING_SERVICE_URL}/sign" \
            -H "Authorization: Bearer ${OIDC_TOKEN}" \
            -H "Content-Type: text/plain" \
            -H "X-Request-ID: ${REQUEST_ID}" \
            --data "$COMMIT_DATA")"

          if [[ "$SIGNATURE" == *"-----BEGIN PGP SIGNATURE-----"* ]]; then
            echo "$SIGNATURE" > /tmp/signature.asc
            echo "signature_file=/tmp/signature.asc" >> "$GITHUB_OUTPUT"
          else
            echo "Error: Invalid signature response"
            echo "$SIGNATURE"
            exit 1
          fi

      - name: Apply Signature
        env:
          SIGNATURE_FILE: ${{ steps.sign.outputs.signature_file }}
        run: |
          # Get the tree
          TREE="$(git cat-file -p HEAD | grep ^tree | cut -d' ' -f2)"

          # Get author and committer info
          AUTHOR="$(git cat-file -p HEAD | grep ^author)"
          COMMITTER="$(git cat-file -p HEAD | grep ^committer)"

          # Get commit message
          MESSAGE="$(git log -1 --format=%B)"

          # Temp vars
          _NEW_COMMIT="/tmp/new_commit"

          # Create new commit object with signature
          {
            echo "tree $TREE"
            # Properly handle multiple parents for merge commits
            git cat-file -p HEAD | grep ^parent | while read -r line; do
              echo "$line"
            done
            echo "$AUTHOR"
            echo "$COMMITTER"
            echo "gpgsig $(cat "$SIGNATURE_FILE" | sed '2,$s/^/ /')"
            echo ""
            echo "$MESSAGE"
          } | git hash-object -t commit --stdin -w > "${_NEW_COMMIT}"

          # Update branch to point to signed commit
          git update-ref HEAD "$(cat "${_NEW_COMMIT}")"

      - name: Verify Signature
        env:
          SIGNING_SERVICE_URL: ${{ vars.SIGNING_SERVICE_URL }}
        run: |
          # Import public key
          curl -s "${SIGNING_SERVICE_URL}/public-key" | gpg --import

          # Verify the signature
          git verify-commit HEAD || echo "Note: Signature verification may fail until key is trusted"

      - name: Push Signed Commit
        run: |
          git push origin HEAD --force-with-lease
