{
  "openapi": "3.0.0",
  "info": {
    "version": "1.0.0",
    "title": "GPG Signing Service API"
  },
  "components": {
    "schemas": {
      "HealthStatus": {
        "type": "string",
        "enum": [
          "healthy",
          "degraded"
        ]
      },
      "HealthResponse": {
        "type": "object",
        "properties": {
          "status": {
            "$ref": "#/components/schemas/HealthStatus"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "version": {
            "type": "string",
            "pattern": "^\\d+\\.\\d+\\.\\d+$"
          },
          "checks": {
            "type": "object",
            "properties": {
              "keyStorage": {
                "type": "boolean"
              },
              "database": {
                "type": "boolean"
              }
            },
            "required": [
              "keyStorage",
              "database"
            ]
          }
        },
        "required": [
          "status",
          "timestamp",
          "version",
          "checks"
        ]
      },
      "PublicKeyResponse": {
        "type": "string",
        "example": "-----BEGIN PGP PUBLIC KEY BLOCK-----\n..."
      },
      "ErrorCode": {
        "type": "string",
        "enum": [
          "AUTH_MISSING",
          "AUTH_INVALID",
          "KEY_NOT_FOUND",
          "KEY_PROCESSING_ERROR",
          "KEY_LIST_ERROR",
          "KEY_UPLOAD_ERROR",
          "KEY_DELETE_ERROR",
          "SIGN_ERROR",
          "RATE_LIMIT_ERROR",
          "RATE_LIMITED",
          "INVALID_REQUEST",
          "AUDIT_ERROR",
          "NOT_FOUND",
          "INTERNAL_ERROR"
        ]
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "error": {
            "type": "string",
            "minLength": 1
          },
          "code": {
            "$ref": "#/components/schemas/ErrorCode"
          },
          "requestId": {
            "type": "string",
            "format": "uuid"
          }
        },
        "required": [
          "error",
          "code"
        ]
      },
      "SignResponse": {
        "type": "string",
        "example": "-----BEGIN PGP SIGNATURE-----\n..."
      },
      "RateLimitError": {
        "type": "object",
        "properties": {
          "error": {
            "type": "string",
            "minLength": 1
          },
          "code": {
            "$ref": "#/components/schemas/ErrorCode"
          },
          "retryAfter": {
            "type": "integer",
            "minimum": 0,
            "exclusiveMinimum": true
          }
        },
        "required": [
          "error",
          "code",
          "retryAfter"
        ]
      },
      "SignRequest": {
        "type": "string",
        "minLength": 1,
        "example": "tree 29ff16c9c14e2652b22f8b78bb08a5a07930c147\nparent ..."
      },
      "KeyResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean"
          },
          "keyId": {
            "type": "string",
            "minLength": 16,
            "maxLength": 16,
            "pattern": "^[A-Fa-f0-9]{16}$"
          },
          "fingerprint": {
            "type": "string",
            "minLength": 40,
            "maxLength": 40,
            "pattern": "^[A-Fa-f0-9]{40}$"
          },
          "algorithm": {
            "type": "string"
          },
          "userId": {
            "type": "string"
          }
        },
        "required": [
          "keyId",
          "fingerprint",
          "algorithm",
          "userId"
        ]
      },
      "KeyUpload": {
        "type": "object",
        "properties": {
          "armoredPrivateKey": {
            "type": "string",
            "minLength": 100,
            "maxLength": 10000
          },
          "keyId": {
            "type": "string",
            "minLength": 16,
            "maxLength": 16,
            "pattern": "^[A-Fa-f0-9]{16}$"
          }
        },
        "required": [
          "armoredPrivateKey",
          "keyId"
        ]
      },
      "KeyListItem": {
        "type": "object",
        "properties": {
          "keyId": {
            "type": "string"
          },
          "fingerprint": {
            "type": "string"
          },
          "createdAt": {
            "type": "string"
          },
          "algorithm": {
            "type": "string"
          }
        },
        "required": [
          "keyId",
          "fingerprint",
          "createdAt",
          "algorithm"
        ]
      },
      "KeyListResponse": {
        "type": "object",
        "properties": {
          "keys": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/KeyListItem"
            }
          }
        },
        "required": [
          "keys"
        ]
      },
      "KeyDeletionResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean"
          },
          "deleted": {
            "type": "boolean"
          }
        },
        "required": [
          "success",
          "deleted"
        ]
      },
      "AuditAction": {
        "type": "string",
        "enum": [
          "sign",
          "key_upload",
          "key_rotate"
        ]
      },
      "AuditLogsResponse": {
        "type": "object",
        "properties": {
          "logs": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "id": {
                  "type": "string",
                  "format": "uuid"
                },
                "timestamp": {
                  "type": "string",
                  "format": "date-time"
                },
                "requestId": {
                  "type": "string",
                  "format": "uuid"
                },
                "action": {
                  "$ref": "#/components/schemas/AuditAction"
                },
                "issuer": {
                  "type": "string",
                  "minLength": 1
                },
                "subject": {
                  "type": "string",
                  "minLength": 1
                },
                "keyId": {
                  "type": "string",
                  "minLength": 1
                },
                "success": {
                  "type": "boolean"
                },
                "errorCode": {
                  "$ref": "#/components/schemas/ErrorCode"
                },
                "metadata": {
                  "type": "string"
                }
              },
              "required": [
                "id",
                "timestamp",
                "requestId",
                "action",
                "issuer",
                "subject",
                "keyId",
                "success"
              ]
            }
          },
          "count": {
            "type": "integer",
            "minimum": 0
          }
        },
        "required": [
          "logs",
          "count"
        ]
      }
    },
    "parameters": {},
    "securitySchemes": {
      "oidcAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "OIDC token from GitHub Actions or GitLab CI"
      },
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Admin token for /admin/* endpoints"
      }
    }
  },
  "paths": {
    "/health": {
      "get": {
        "summary": "Health check",
        "description": "Check the health of the service",
        "responses": {
          "200": {
            "description": "Service is healthy",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HealthResponse"
                }
              }
            }
          },
          "503": {
            "description": "Service is degraded",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HealthResponse"
                }
              }
            }
          }
        }
      }
    },
    "/public-key": {
      "get": {
        "summary": "Get public key",
        "description": "Get the public key for signature verification",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "example": "A1B2C3D4E5F6G7H8"
            },
            "required": false,
            "name": "keyId",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Public Key",
            "content": {
              "application/pgp-keys": {
                "schema": {
                  "$ref": "#/components/schemas/PublicKeyResponse"
                }
              }
            }
          },
          "404": {
            "description": "Key not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/sign": {
      "post": {
        "summary": "Sign commit data",
        "description": "Sign git commit data using the stored GPG key",
        "security": [
          {
            "oidcAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "example": "A1B2C3D4E5F6G7H8"
            },
            "required": false,
            "name": "keyId",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "required": false,
            "name": "X-Request-ID",
            "in": "header"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "text/plain": {
              "schema": {
                "$ref": "#/components/schemas/SignRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "PGP Signature",
            "content": {
              "text/plain": {
                "schema": {
                  "$ref": "#/components/schemas/SignResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "404": {
            "description": "Key not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "429": {
            "description": "Rate limit exceeded",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RateLimitError"
                }
              }
            }
          },
          "500": {
            "description": "Internal Server Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "503": {
            "description": "Service Unavailable",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/admin/keys": {
      "post": {
        "summary": "Upload a new signing key",
        "description": "Upload a GPG private key for signing",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/KeyUpload"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Key uploaded successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/KeyResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid request",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      },
      "get": {
        "summary": "List all keys",
        "description": "List metadata for all stored keys",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "List of keys",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/KeyListResponse"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/admin/keys/{keyId}/public": {
      "get": {
        "summary": "Get public key",
        "description": "Get the public key for a specific key ID",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "example": "A1B2C3D4E5F6G7H8"
            },
            "required": true,
            "name": "keyId",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Public Key",
            "content": {
              "application/pgp-keys": {
                "schema": {
                  "type": "string"
                }
              }
            }
          },
          "404": {
            "description": "Key not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/admin/keys/{keyId}": {
      "delete": {
        "summary": "Delete a key",
        "description": "Delete a stored key",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "example": "A1B2C3D4E5F6G7H8"
            },
            "required": true,
            "name": "keyId",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Key deleted",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/KeyDeletionResponse"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/admin/audit": {
      "get": {
        "summary": "Get audit logs",
        "description": "Retrieve audit logs with filtering",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 1000,
              "default": 100,
              "example": 100
            },
            "required": false,
            "name": "limit",
            "in": "query"
          },
          {
            "schema": {
              "type": "integer",
              "nullable": true,
              "minimum": 0,
              "default": 0,
              "example": 0
            },
            "required": false,
            "name": "offset",
            "in": "query"
          },
          {
            "schema": {
              "type": "string"
            },
            "required": false,
            "name": "action",
            "in": "query"
          },
          {
            "schema": {
              "type": "string"
            },
            "required": false,
            "name": "subject",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "format": "date-time"
            },
            "required": false,
            "name": "startDate",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "format": "date-time"
            },
            "required": false,
            "name": "endDate",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Audit logs",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AuditLogsResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid request",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    }
  }
}