{
  "openapi": "3.0.4",
  "info": {
    "version": "1.0.0",
    "title": "GPG Signing Service API"
  },
  "components": {
    "schemas": {},
    "parameters": {}
  },
  "paths": {
    "/health": {
      "get": {
        "summary": "Health check",
        "description": "Check the health of the service",
        "responses": {
          "200": {
            "description": "Service is healthy",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "status": {
                      "type": "string",
                      "enum": [
                        "healthy",
                        "degraded"
                      ]
                    },
                    "timestamp": {
                      "type": "string",
                      "format": "date-time"
                    },
                    "version": {
                      "type": "string",
                      "pattern": "^\\d+\\.\\d+\\.\\d+$"
                    },
                    "checks": {
                      "type": "object",
                      "properties": {
                        "keyStorage": {
                          "type": "boolean"
                        },
                        "database": {
                          "type": "boolean"
                        }
                      },
                      "required": [
                        "keyStorage",
                        "database"
                      ]
                    }
                  },
                  "required": [
                    "status",
                    "timestamp",
                    "version",
                    "checks"
                  ]
                }
              }
            }
          },
          "503": {
            "description": "Service is degraded",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "status": {
                      "type": "string",
                      "enum": [
                        "healthy",
                        "degraded"
                      ]
                    },
                    "timestamp": {
                      "type": "string",
                      "format": "date-time"
                    },
                    "version": {
                      "type": "string",
                      "pattern": "^\\d+\\.\\d+\\.\\d+$"
                    },
                    "checks": {
                      "type": "object",
                      "properties": {
                        "keyStorage": {
                          "type": "boolean"
                        },
                        "database": {
                          "type": "boolean"
                        }
                      },
                      "required": [
                        "keyStorage",
                        "database"
                      ]
                    }
                  },
                  "required": [
                    "status",
                    "timestamp",
                    "version",
                    "checks"
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/public-key": {
      "get": {
        "summary": "Get public key",
        "description": "Get the public key for signature verification",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "example": "A1B2C3D4E5F6G7H8"
            },
            "required": false,
            "name": "keyId",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Public Key",
            "content": {
              "application/pgp-keys": {
                "schema": {
                  "type": "string"
                }
              }
            }
          },
          "404": {
            "description": "Key not found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "minLength": 1
                    },
                    "code": {
                      "type": "string",
                      "enum": [
                        "AUTH_MISSING",
                        "AUTH_INVALID",
                        "KEY_NOT_FOUND",
                        "KEY_PROCESSING_ERROR",
                        "KEY_LIST_ERROR",
                        "KEY_UPLOAD_ERROR",
                        "KEY_DELETE_ERROR",
                        "SIGN_ERROR",
                        "RATE_LIMIT_ERROR",
                        "RATE_LIMITED",
                        "INVALID_REQUEST",
                        "AUDIT_ERROR",
                        "NOT_FOUND",
                        "INTERNAL_ERROR"
                      ]
                    },
                    "requestId": {
                      "type": "string",
                      "format": "uuid"
                    }
                  },
                  "required": [
                    "error",
                    "code"
                  ]
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "minLength": 1
                    },
                    "code": {
                      "type": "string",
                      "enum": [
                        "AUTH_MISSING",
                        "AUTH_INVALID",
                        "KEY_NOT_FOUND",
                        "KEY_PROCESSING_ERROR",
                        "KEY_LIST_ERROR",
                        "KEY_UPLOAD_ERROR",
                        "KEY_DELETE_ERROR",
                        "SIGN_ERROR",
                        "RATE_LIMIT_ERROR",
                        "RATE_LIMITED",
                        "INVALID_REQUEST",
                        "AUDIT_ERROR",
                        "NOT_FOUND",
                        "INTERNAL_ERROR"
                      ]
                    },
                    "requestId": {
                      "type": "string",
                      "format": "uuid"
                    }
                  },
                  "required": [
                    "error",
                    "code"
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/sign": {
      "post": {
        "summary": "Sign commit data",
        "description": "Sign git commit data using the stored GPG key",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "example": "A1B2C3D4E5F6G7H8"
            },
            "required": false,
            "name": "keyId",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "required": false,
            "name": "X-Request-ID",
            "in": "header"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "text/plain": {
              "schema": {
                "type": "string",
                "minLength": 1,
                "example": "tree 29ff16c9c14e2652b22f8b78bb08a5a07930c147\nparent ..."
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "PGP Signature",
            "content": {
              "text/plain": {
                "schema": {
                  "type": "string",
                  "example": "-----BEGIN PGP SIGNATURE-----\n..."
                }
              }
            }
          },
          "400": {
            "description": "Bad Request",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "minLength": 1
                    },
                    "code": {
                      "type": "string",
                      "enum": [
                        "AUTH_MISSING",
                        "AUTH_INVALID",
                        "KEY_NOT_FOUND",
                        "KEY_PROCESSING_ERROR",
                        "KEY_LIST_ERROR",
                        "KEY_UPLOAD_ERROR",
                        "KEY_DELETE_ERROR",
                        "SIGN_ERROR",
                        "RATE_LIMIT_ERROR",
                        "RATE_LIMITED",
                        "INVALID_REQUEST",
                        "AUDIT_ERROR",
                        "NOT_FOUND",
                        "INTERNAL_ERROR"
                      ]
                    },
                    "requestId": {
                      "type": "string",
                      "format": "uuid"
                    }
                  },
                  "required": [
                    "error",
                    "code"
                  ]
                }
              }
            }
          },
          "404": {
            "description": "Key not found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "minLength": 1
                    },
                    "code": {
                      "type": "string",
                      "enum": [
                        "AUTH_MISSING",
                        "AUTH_INVALID",
                        "KEY_NOT_FOUND",
                        "KEY_PROCESSING_ERROR",
                        "KEY_LIST_ERROR",
                        "KEY_UPLOAD_ERROR",
                        "KEY_DELETE_ERROR",
                        "SIGN_ERROR",
                        "RATE_LIMIT_ERROR",
                        "RATE_LIMITED",
                        "INVALID_REQUEST",
                        "AUDIT_ERROR",
                        "NOT_FOUND",
                        "INTERNAL_ERROR"
                      ]
                    },
                    "requestId": {
                      "type": "string",
                      "format": "uuid"
                    }
                  },
                  "required": [
                    "error",
                    "code"
                  ]
                }
              }
            }
          },
          "429": {
            "description": "Rate limit exceeded",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    },
                    "code": {
                      "type": "string"
                    },
                    "retryAfter": {
                      "type": "number"
                    }
                  },
                  "required": [
                    "error",
                    "code",
                    "retryAfter"
                  ]
                }
              }
            }
          },
          "500": {
            "description": "Internal Server Error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "minLength": 1
                    },
                    "code": {
                      "type": "string",
                      "enum": [
                        "AUTH_MISSING",
                        "AUTH_INVALID",
                        "KEY_NOT_FOUND",
                        "KEY_PROCESSING_ERROR",
                        "KEY_LIST_ERROR",
                        "KEY_UPLOAD_ERROR",
                        "KEY_DELETE_ERROR",
                        "SIGN_ERROR",
                        "RATE_LIMIT_ERROR",
                        "RATE_LIMITED",
                        "INVALID_REQUEST",
                        "AUDIT_ERROR",
                        "NOT_FOUND",
                        "INTERNAL_ERROR"
                      ]
                    },
                    "requestId": {
                      "type": "string",
                      "format": "uuid"
                    }
                  },
                  "required": [
                    "error",
                    "code"
                  ]
                }
              }
            }
          },
          "503": {
            "description": "Service Unavailable",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "minLength": 1
                    },
                    "code": {
                      "type": "string",
                      "enum": [
                        "AUTH_MISSING",
                        "AUTH_INVALID",
                        "KEY_NOT_FOUND",
                        "KEY_PROCESSING_ERROR",
                        "KEY_LIST_ERROR",
                        "KEY_UPLOAD_ERROR",
                        "KEY_DELETE_ERROR",
                        "SIGN_ERROR",
                        "RATE_LIMIT_ERROR",
                        "RATE_LIMITED",
                        "INVALID_REQUEST",
                        "AUDIT_ERROR",
                        "NOT_FOUND",
                        "INTERNAL_ERROR"
                      ]
                    },
                    "requestId": {
                      "type": "string",
                      "format": "uuid"
                    }
                  },
                  "required": [
                    "error",
                    "code"
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/admin/keys": {
      "post": {
        "summary": "Upload a new signing key",
        "description": "Upload a GPG private key for signing",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "armoredPrivateKey": {
                    "type": "string",
                    "example": "-----BEGIN PGP PRIVATE KEY BLOCK-----\\n..."
                  },
                  "keyId": {
                    "type": "string",
                    "example": "A1B2C3D4E5F6G7H8"
                  }
                },
                "required": [
                  "armoredPrivateKey",
                  "keyId"
                ]
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Key uploaded successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "keyId": {
                      "type": "string"
                    },
                    "fingerprint": {
                      "type": "string"
                    },
                    "algorithm": {
                      "type": "string"
                    },
                    "userId": {
                      "type": "string"
                    }
                  },
                  "required": [
                    "success",
                    "keyId",
                    "fingerprint",
                    "algorithm",
                    "userId"
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Invalid request",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "minLength": 1
                    },
                    "code": {
                      "type": "string",
                      "enum": [
                        "AUTH_MISSING",
                        "AUTH_INVALID",
                        "KEY_NOT_FOUND",
                        "KEY_PROCESSING_ERROR",
                        "KEY_LIST_ERROR",
                        "KEY_UPLOAD_ERROR",
                        "KEY_DELETE_ERROR",
                        "SIGN_ERROR",
                        "RATE_LIMIT_ERROR",
                        "RATE_LIMITED",
                        "INVALID_REQUEST",
                        "AUDIT_ERROR",
                        "NOT_FOUND",
                        "INTERNAL_ERROR"
                      ]
                    },
                    "requestId": {
                      "type": "string",
                      "format": "uuid"
                    }
                  },
                  "required": [
                    "error",
                    "code"
                  ]
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "minLength": 1
                    },
                    "code": {
                      "type": "string",
                      "enum": [
                        "AUTH_MISSING",
                        "AUTH_INVALID",
                        "KEY_NOT_FOUND",
                        "KEY_PROCESSING_ERROR",
                        "KEY_LIST_ERROR",
                        "KEY_UPLOAD_ERROR",
                        "KEY_DELETE_ERROR",
                        "SIGN_ERROR",
                        "RATE_LIMIT_ERROR",
                        "RATE_LIMITED",
                        "INVALID_REQUEST",
                        "AUDIT_ERROR",
                        "NOT_FOUND",
                        "INTERNAL_ERROR"
                      ]
                    },
                    "requestId": {
                      "type": "string",
                      "format": "uuid"
                    }
                  },
                  "required": [
                    "error",
                    "code"
                  ]
                }
              }
            }
          }
        }
      },
      "get": {
        "summary": "List all keys",
        "description": "List metadata for all stored keys",
        "responses": {
          "200": {
            "description": "List of keys",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "keys": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "keyId": {
                            "type": "string"
                          },
                          "fingerprint": {
                            "type": "string"
                          },
                          "createdAt": {
                            "type": "string"
                          },
                          "algorithm": {
                            "type": "string"
                          }
                        },
                        "required": [
                          "keyId",
                          "fingerprint",
                          "createdAt",
                          "algorithm"
                        ]
                      }
                    }
                  },
                  "required": [
                    "keys"
                  ]
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "minLength": 1
                    },
                    "code": {
                      "type": "string",
                      "enum": [
                        "AUTH_MISSING",
                        "AUTH_INVALID",
                        "KEY_NOT_FOUND",
                        "KEY_PROCESSING_ERROR",
                        "KEY_LIST_ERROR",
                        "KEY_UPLOAD_ERROR",
                        "KEY_DELETE_ERROR",
                        "SIGN_ERROR",
                        "RATE_LIMIT_ERROR",
                        "RATE_LIMITED",
                        "INVALID_REQUEST",
                        "AUDIT_ERROR",
                        "NOT_FOUND",
                        "INTERNAL_ERROR"
                      ]
                    },
                    "requestId": {
                      "type": "string",
                      "format": "uuid"
                    }
                  },
                  "required": [
                    "error",
                    "code"
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/admin/keys/{keyId}/public": {
      "get": {
        "summary": "Get public key",
        "description": "Get the public key for a specific key ID",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "example": "A1B2C3D4E5F6G7H8"
            },
            "required": true,
            "name": "keyId",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Public Key",
            "content": {
              "application/pgp-keys": {
                "schema": {
                  "type": "string"
                }
              }
            }
          },
          "404": {
            "description": "Key not found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "minLength": 1
                    },
                    "code": {
                      "type": "string",
                      "enum": [
                        "AUTH_MISSING",
                        "AUTH_INVALID",
                        "KEY_NOT_FOUND",
                        "KEY_PROCESSING_ERROR",
                        "KEY_LIST_ERROR",
                        "KEY_UPLOAD_ERROR",
                        "KEY_DELETE_ERROR",
                        "SIGN_ERROR",
                        "RATE_LIMIT_ERROR",
                        "RATE_LIMITED",
                        "INVALID_REQUEST",
                        "AUDIT_ERROR",
                        "NOT_FOUND",
                        "INTERNAL_ERROR"
                      ]
                    },
                    "requestId": {
                      "type": "string",
                      "format": "uuid"
                    }
                  },
                  "required": [
                    "error",
                    "code"
                  ]
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "minLength": 1
                    },
                    "code": {
                      "type": "string",
                      "enum": [
                        "AUTH_MISSING",
                        "AUTH_INVALID",
                        "KEY_NOT_FOUND",
                        "KEY_PROCESSING_ERROR",
                        "KEY_LIST_ERROR",
                        "KEY_UPLOAD_ERROR",
                        "KEY_DELETE_ERROR",
                        "SIGN_ERROR",
                        "RATE_LIMIT_ERROR",
                        "RATE_LIMITED",
                        "INVALID_REQUEST",
                        "AUDIT_ERROR",
                        "NOT_FOUND",
                        "INTERNAL_ERROR"
                      ]
                    },
                    "requestId": {
                      "type": "string",
                      "format": "uuid"
                    }
                  },
                  "required": [
                    "error",
                    "code"
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/admin/keys/{keyId}": {
      "delete": {
        "summary": "Delete a key",
        "description": "Delete a stored key",
        "parameters": [
          {
            "schema": {
              "type": "string",
              "example": "A1B2C3D4E5F6G7H8"
            },
            "required": true,
            "name": "keyId",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Key deleted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "deleted": {
                      "type": "boolean"
                    }
                  },
                  "required": [
                    "success",
                    "deleted"
                  ]
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "minLength": 1
                    },
                    "code": {
                      "type": "string",
                      "enum": [
                        "AUTH_MISSING",
                        "AUTH_INVALID",
                        "KEY_NOT_FOUND",
                        "KEY_PROCESSING_ERROR",
                        "KEY_LIST_ERROR",
                        "KEY_UPLOAD_ERROR",
                        "KEY_DELETE_ERROR",
                        "SIGN_ERROR",
                        "RATE_LIMIT_ERROR",
                        "RATE_LIMITED",
                        "INVALID_REQUEST",
                        "AUDIT_ERROR",
                        "NOT_FOUND",
                        "INTERNAL_ERROR"
                      ]
                    },
                    "requestId": {
                      "type": "string",
                      "format": "uuid"
                    }
                  },
                  "required": [
                    "error",
                    "code"
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/admin/audit": {
      "get": {
        "summary": "Get audit logs",
        "description": "Retrieve audit logs with filtering",
        "parameters": [
          {
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 1000,
              "default": 100,
              "example": 100
            },
            "required": false,
            "name": "limit",
            "in": "query"
          },
          {
            "schema": {
              "type": "integer",
              "nullable": true,
              "minimum": 0,
              "default": 0,
              "example": 0
            },
            "required": false,
            "name": "offset",
            "in": "query"
          },
          {
            "schema": {
              "type": "string"
            },
            "required": false,
            "name": "action",
            "in": "query"
          },
          {
            "schema": {
              "type": "string"
            },
            "required": false,
            "name": "subject",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "format": "date-time"
            },
            "required": false,
            "name": "startDate",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "format": "date-time"
            },
            "required": false,
            "name": "endDate",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Audit logs",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "logs": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string"
                          },
                          "timestamp": {
                            "type": "string"
                          },
                          "requestId": {
                            "type": "string"
                          },
                          "action": {
                            "type": "string"
                          },
                          "issuer": {
                            "type": "string"
                          },
                          "subject": {
                            "type": "string"
                          },
                          "keyId": {
                            "type": "string"
                          },
                          "success": {
                            "type": "boolean"
                          },
                          "errorCode": {
                            "type": "string"
                          },
                          "metadata": {
                            "type": "string"
                          }
                        },
                        "required": [
                          "id",
                          "timestamp",
                          "requestId",
                          "action",
                          "issuer",
                          "subject",
                          "keyId",
                          "success"
                        ]
                      }
                    },
                    "count": {
                      "type": "number"
                    }
                  },
                  "required": [
                    "logs",
                    "count"
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Invalid request",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "minLength": 1
                    },
                    "code": {
                      "type": "string",
                      "enum": [
                        "AUTH_MISSING",
                        "AUTH_INVALID",
                        "KEY_NOT_FOUND",
                        "KEY_PROCESSING_ERROR",
                        "KEY_LIST_ERROR",
                        "KEY_UPLOAD_ERROR",
                        "KEY_DELETE_ERROR",
                        "SIGN_ERROR",
                        "RATE_LIMIT_ERROR",
                        "RATE_LIMITED",
                        "INVALID_REQUEST",
                        "AUDIT_ERROR",
                        "NOT_FOUND",
                        "INTERNAL_ERROR"
                      ]
                    },
                    "requestId": {
                      "type": "string",
                      "format": "uuid"
                    }
                  },
                  "required": [
                    "error",
                    "code"
                  ]
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "minLength": 1
                    },
                    "code": {
                      "type": "string",
                      "enum": [
                        "AUTH_MISSING",
                        "AUTH_INVALID",
                        "KEY_NOT_FOUND",
                        "KEY_PROCESSING_ERROR",
                        "KEY_LIST_ERROR",
                        "KEY_UPLOAD_ERROR",
                        "KEY_DELETE_ERROR",
                        "SIGN_ERROR",
                        "RATE_LIMIT_ERROR",
                        "RATE_LIMITED",
                        "INVALID_REQUEST",
                        "AUDIT_ERROR",
                        "NOT_FOUND",
                        "INTERNAL_ERROR"
                      ]
                    },
                    "requestId": {
                      "type": "string",
                      "format": "uuid"
                    }
                  },
                  "required": [
                    "error",
                    "code"
                  ]
                }
              }
            }
          }
        }
      }
    }
  }
}