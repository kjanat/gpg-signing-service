#:schema ./node_modules/wrangler/config-schema.json
# https://www.unpkg.com/wrangler/config-schema.json

name = "gpg-signing-service"
main = "src/index.ts"
compatibility_date = "2025-11-13"
compatibility_flags = ["nodejs_compat"]
observability = { enabled = true }
workers_dev = true
# Smart placement
# Docs: https://developers.cloudflare.com/workers/configuration/smart-placement/#smart-placement
placement = { mode = "smart" }

# Bindings
# Bindings allow your Worker to interact with resources on the Cloudflare Developer Platform, including
# databases, object storage, AI inference, real-time communication and more.
# Docs: https://developers.cloudflare.com/workers/runtime-apis/bindings/
# # Durable Objects
# # Docs: https://developers.cloudflare.com/workers/wrangler/configuration/#durable-objects
[[durable_objects.bindings]]
name = "KEY_STORAGE"
class_name = "KeyStorage"

[[durable_objects.bindings]]
name = "RATE_LIMITER"
class_name = "RateLimiter"

# Migrations for Durable Objects (SQLite-backed for free plan)
[[migrations]]
tag = "v1"
new_sqlite_classes = ["KeyStorage", "RateLimiter"]

# D1 Database for audit logs
# Docs: https://developers.cloudflare.com/workers/wrangler/configuration/#d1-databases
[[d1_databases]]
binding = "AUDIT_DB"
database_name = "gpg-signing-audit"
# Set after `wrangler d1 create gpg-signing-audit`
database_id = "46e29014-341c-47d1-adbb-e644ae28691c"

# KV for JWKS caching
# Docs: https://developers.cloudflare.com/workers/wrangler/configuration/#kv-namespaces
[[kv_namespaces]]
binding = "JWKS_CACHE"
# Set after `wrangler kv namespace create JWKS_CACHE`
id = "b4e1807f785b4b66b012004b14316d6a"

# Custom domain
# Docs: https://developers.cloudflare.com/workers/wrangler/configuration/#custom-domains
[[routes]]
pattern = "gpg.kajkowalski.nl"
custom_domain = true

# Environment variables (non-sensitive)
# Docs: https://developers.cloudflare.com/workers/wrangler/configuration/#environment-variables
# # Note: Use secrets to store sensitive data.
# # https://developers.cloudflare.com/workers/configuration/secrets/
[vars]
BUN_VERSION = "1.3.3"
# SKIP_DEPENDENCY_INSTALL = "1"
ALLOWED_ISSUERS = "https://token.actions.githubusercontent.com,https://gitlab.com"
KEY_ID = "62E75E54497815DD"

# Secrets (set via `wrangler secret put`)
# - KEY_PASSPHRASE: Passphrase for encrypted private key
# - ADMIN_TOKEN: Token for admin endpoints

# =============================================================================
# STAGING ENVIRONMENT
# Deploy with: wrangler deploy --env staging
# Secrets: wrangler secret put KEY_PASSPHRASE --env staging
# =============================================================================
[env.staging]
name = "gpg-signing-service-staging"
workers_dev = true

[[env.staging.routes]]
pattern = "staging.gpg.kajkowalski.nl"
custom_domain = true

# Bindings are non-inheritable - must be specified per environment
[[env.staging.durable_objects.bindings]]
name = "KEY_STORAGE"
class_name = "KeyStorage"

[[env.staging.durable_objects.bindings]]
name = "RATE_LIMITER"
class_name = "RateLimiter"

# Staging D1 Database - create with: wrangler d1 create gpg-signing-audit-staging
[[env.staging.d1_databases]]
binding = "AUDIT_DB"
database_name = "gpg-signing-audit-staging"
database_id = "22ec5e27-27d6-48d6-a921-61344dd5d7c2"

# Staging KV - create with: wrangler kv namespace create JWKS_CACHE --env staging
[[env.staging.kv_namespaces]]
binding = "JWKS_CACHE"
id = "1a1c95b63a59458a9347be82f1b961df"

# Staging environment variables
[env.staging.vars]
BUN_VERSION = "1.3.3"
ALLOWED_ISSUERS = "https://token.actions.githubusercontent.com,https://gitlab.com"
KEY_ID = "62E75E54497815DD"
ENVIRONMENT = "staging"
